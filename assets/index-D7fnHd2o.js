(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class B{components;constructor(e=0,t=0,s=0){this.components=new Float32Array(3),this.components[0]=e,this.components[1]=t,this.components[2]=s}static scale(e,t){return new B(e.components[0]*t,e.components[1]*t,e.components[2]*t)}static add(e,t){return e.clone().add(t)}static subtract(e,t){return e.clone().subtract(t)}static cross(e,t){const s=e.components[0],n=e.components[1],i=e.components[2],o=t.components[0],r=t.components[1],a=t.components[2];return new B(n*a-i*r,i*o-s*a,s*r-n*o)}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}normalise(){const e=1/this.magnitude;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}clone(){return new B(this.components[0],this.components[1],this.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class E{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}copyFrom(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this.components[3]=e.components[3],this.components[4]=e.components[4],this.components[5]=e.components[5],this.components[6]=e.components[6],this.components[7]=e.components[7],this.components[8]=e.components[8],this.components[9]=e.components[9],this.components[10]=e.components[10],this.components[11]=e.components[11],this.components[12]=e.components[12],this.components[13]=e.components[13],this.components[14]=e.components[14],this.components[15]=e.components[15],this}invert(){const e=this.components[0],t=this.components[1],s=this.components[2],n=this.components[3],i=this.components[4],o=this.components[5],r=this.components[6],a=this.components[7],c=this.components[8],g=this.components[9],y=this.components[10],d=this.components[11],f=this.components[12],b=this.components[13],h=this.components[14],w=this.components[15],v=e*o-t*i,x=e*r-s*i,T=e*a-n*i,p=t*r-s*o,m=t*a-n*o,u=s*a-n*r,l=c*b-g*f,S=c*h-y*f,R=c*w-d*f,M=g*h-y*b,F=g*w-d*b,k=y*w-d*h,O=v*k-x*F+T*M+p*R-m*S+u*l;if(O===0)return console.warn("Determinant is 0. Matrix not inverted"),this;const P=1/O;return this.components[0]=(o*k-r*F+a*M)*P,this.components[1]=(s*F-t*k-n*M)*P,this.components[2]=(b*u-h*m+w*p)*P,this.components[3]=(y*m-g*u-d*p)*P,this.components[4]=(r*R-i*k-a*S)*P,this.components[5]=(e*k-s*R+n*S)*P,this.components[6]=(h*T-f*u-w*x)*P,this.components[7]=(c*u-y*T+d*x)*P,this.components[8]=(i*F-o*R+a*l)*P,this.components[9]=(t*R-e*F-n*l)*P,this.components[10]=(f*m-b*T+w*v)*P,this.components[11]=(g*T-c*m-d*v)*P,this.components[12]=(o*S-i*M-r*l)*P,this.components[13]=(e*M-t*S+s*l)*P,this.components[14]=(b*x-f*p-h*v)*P,this.components[15]=(c*p-g*x+y*v)*P,this}postMultiply(e){return E.multiply(this,e,this),this}static multiply(e,t,s=new E){const n=e.components[0],i=e.components[1],o=e.components[2],r=e.components[3],a=e.components[4],c=e.components[5],g=e.components[6],y=e.components[7],d=e.components[8],f=e.components[9],b=e.components[10],h=e.components[11],w=e.components[12],v=e.components[13],x=e.components[14],T=e.components[15];let p=t.components[0],m=t.components[1],u=t.components[2],l=t.components[3];return s.components[0]=p*n+m*a+u*d+l*w,s.components[1]=p*i+m*c+u*f+l*v,s.components[2]=p*o+m*g+u*b+l*x,s.components[3]=p*r+m*y+u*h+l*T,p=t.components[4],m=t.components[5],u=t.components[6],l=t.components[7],s.components[4]=p*n+m*a+u*d+l*w,s.components[5]=p*i+m*c+u*f+l*v,s.components[6]=p*o+m*g+u*b+l*x,s.components[7]=p*r+m*y+u*h+l*T,p=t.components[8],m=t.components[9],u=t.components[10],l=t.components[11],s.components[8]=p*n+m*a+u*d+l*w,s.components[9]=p*i+m*c+u*f+l*v,s.components[10]=p*o+m*g+u*b+l*x,s.components[11]=p*r+m*y+u*h+l*T,p=t.components[12],m=t.components[13],u=t.components[14],l=t.components[15],s.components[12]=p*n+m*a+u*d+l*w,s.components[13]=p*i+m*c+u*f+l*v,s.components[14]=p*o+m*g+u*b+l*x,s.components[15]=p*r+m*y+u*h+l*T,s}static perspective(e,t,s,n){const i=new E,o=1/Math.tan(e/2);if(i.components[0]=o/t,i.components[5]=o,i.components[11]=-1,i.components[15]=0,n!==1/0){const r=1/(s-n);i.components[10]=n*r,i.components[14]=n*s*r}else i.components[10]=-1,i.components[14]=-s;return i}static lookAt(e,t,s){const n=new E,i=1e-6;let o,r,a,c,g,y,d,f,b,h;const w=e.x,v=e.y,x=e.z,T=s.x,p=s.y,m=s.z,u=t.x,l=t.y,S=t.z;return Math.abs(w-u)<i&&Math.abs(v-l)<i&&Math.abs(x-S)<i?(console.warn("Look At too close to Position"),new E):(d=w-u,f=v-l,b=x-S,h=1/Math.hypot(d,f,b),d*=h,f*=h,b*=h,o=p*b-m*f,r=m*d-T*b,a=T*f-p*d,h=Math.hypot(o,r,a),h?(h=1/h,o*=h,r*=h,a*=h):(o=0,r=0,a=0),c=f*a-b*r,g=b*o-d*a,y=d*r-f*o,h=Math.hypot(c,g,y),h?(h=1/h,c*=h,g*=h,y*=h):(c=0,g=0,y=0),n.components[0]=o,n.components[1]=c,n.components[2]=d,n.components[3]=0,n.components[4]=r,n.components[5]=g,n.components[6]=f,n.components[7]=0,n.components[8]=a,n.components[9]=y,n.components[10]=b,n.components[11]=0,n.components[12]=-(o*w+r*v+a*x),n.components[13]=-(c*w+g*v+y*x),n.components[14]=-(d*w+f*v+b*x),n.components[15]=1,n)}}class D{buffer;dataview;littleEndian;offset;constructor(e,t=!0,s=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=s}toFloat32Array(){return new Float32Array(this.buffer)}writeUint8(e){this.dataview.setUint8(this.offset,e),this.offset+=1}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeVec3f(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat4x4f(e){for(let t=0;t<16;t++)this.writeFloat32(e.components[t])}pad(e){for(let t=0;t<e;t++)this.writeUint8(0)}}function C(G){return`/Black-Hole-Simulation/${G}`}class A{static BYTE_LENGTH=8*Float32Array.BYTES_PER_ELEMENT;static GLOBAL_UP=new B(0,1,0);imageWidth;imageHeight;fieldOfView;position;lookAt;up;right;back;initialised;device;buffer;constructor(e={}){this.imageWidth=e.imageWidth??1920,this.imageHeight=e.imageHeight??1080,this.fieldOfView=e.fieldOfView??Math.PI/3,this.position=e.position??new B,this.lookAt=e.lookAt??new B(0,0,-1),this.initialised=!1}serialise(){const e=new D(A.BYTE_LENGTH);return e.writeVec3f(this.position),e.pad(4),e.writeFloat32(this.imageWidth),e.writeFloat32(this.imageHeight),e.writeFloat32(B.subtract(this.position,this.lookAt).magnitude),e.writeFloat32(this.fieldOfView),e.buffer}initialise(e){this.initialised||(this.device=e,this.buffer=e.createBuffer({label:"Camera Buffer",size:A.BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.initialised=!0,this.updateBuffer())}updateBuffer(){this.initialised&&(this.back=B.subtract(this.position,this.lookAt).normalise(),this.right=B.cross(A.GLOBAL_UP,this.back),this.up=B.cross(this.back,this.right),this.device.queue.writeBuffer(this.buffer,0,this.serialise()))}setImageDimensions(e,t){this.imageWidth=e,this.imageHeight=t,this.updateBuffer()}get aspectRatio(){return this.imageWidth/this.imageHeight}getPerspectiveViewMatrix(){return this.getPerspectiveMatrix().postMultiply(this.getViewMatrix())}getPerspectiveMatrix(){return E.perspective(this.fieldOfView,this.aspectRatio,.01,1/0)}getViewMatrix(){const e=B.scale(this.back,-1);return E.lookAt(this.position,B.add(this.position,e),this.up)}}class U{shader;constructor(e,t,s){this.shader=e.createShaderModule({label:s,code:t})}static async fetch(e,t,s){const n=await(await fetch(t)).text(),i=await U.preprocess(t,n);return new U(e,i,s)}static async preprocess(e,t){return U.resolveImports(e,t)}static async resolveImports(e,t,s=[]){const n=/#!import.*\s/g,i=e.split("/"),o=i.slice(0,i.length-1).join("/")+"/",r=t.match(n)?.map(c=>c.replaceAll(/(#!import)|\s/g,"")).filter(c=>!s.includes(c)).map(c=>o+c+".wgsl")??[];return((await Promise.all(r.map(async c=>{const g=await(await fetch(c)).text();return U.resolveImports(c,g,s)}))).join("")+t).replaceAll(n,"")}}class N{label;texture;constructor(e,t){this.label=e,this.texture=t}static async create(e,t,...s){const n=s.map(async a=>await(await fetch(C(a))).blob()),i=await Promise.all(n),o=await Promise.all(i.map(a=>createImageBitmap(a))),r=e.createTexture({label:t,format:"rgba8unorm",size:[o[0].width,o[0].height,o.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let a=0;a<o.length;a++){const c=o[a];e.queue.copyExternalImageToTexture({source:c},{texture:r,origin:[0,0,a]},{width:c.width,height:c.height})}return new N(t,r)}static async createCubemap(e,t,s){return await N.create(e,t,`${s}/px.png`,`${s}/nx.png`,`${s}/py.png`,`${s}/ny.png`,`${s}/pz.png`,`${s}/nz.png`)}}function z(G,e,t,s){const n=G.createBuffer({label:e,usage:t,size:typeof s=="number"?s:s.byteLength});return typeof s!="number"&&G.queue.writeBuffer(n,0,s),n}class V extends E{buffer;device;label;constructor(e,t,s=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.label=t,this.device=e,this.buffer=z(e,this.label,s,this.components.buffer)}writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components.buffer)}}class I{device;inversePespectiveViewMatrix;bindGroups=[];label;skyboxes;sampler;framebuffer;dimensions;activeSkybox;renderBindGroupLayout;renderPipeline;constructor(e,t,s,n,i){this.activeSkybox=-1,this.skyboxes=[],this.bindGroups=[],this.dimensions=n,this.device=e,this.label=i,this.inversePespectiveViewMatrix=new V(e,`${this.label} Inverse Perspective View Matrix Buffer`),this.framebuffer=this.createFramebuffer(),this.sampler=this.device.createSampler({label:`${this.label} Sampler`}),this.renderBindGroupLayout=this.device.createBindGroupLayout({label:`${this.label} Bind Group Layout`,entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const o=this.device.createPipelineLayout({label:`${this.label} Render Pipeline Layout`,bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:`${this.label} Render Pipeline`,layout:o,vertex:{module:t.shader,entryPoint:"vertexMain"},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:s}]}});for(let r=0,a=this.skyboxes.length;r<a;r++){const c=this.skyboxes[r];this.skyboxes.splice(0,1),this.addSkybox(c)}}static async create(e,t,s,n){const i=await U.fetch(e,C("shaders/skybox.wgsl"),`${n} Shader Module`);return new I(e,i,t,s,n)}createFramebuffer(){return this.device.createTexture({label:`${this.label} Framebuffer`,format:"rgba8unorm",size:this.dimensions,usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST})}addSkybox(e){const t=this.device.createBindGroup({label:`${this.label} ${e.label} Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix.buffer}}]});this.skyboxes.push(e),this.bindGroups.push(t)}setActiveSkybox(e){if(e===null){this.activeSkybox=-1;return}this.skyboxes.includes(e)||this.addSkybox(e);const t=this.skyboxes.findIndex(s=>s===e);this.activeSkybox=t}render(e){if(this.activeSkybox===-1){console.warn("No active skybox");return}this.inversePespectiveViewMatrix.copyFrom(e.getPerspectiveViewMatrix().invert()),this.inversePespectiveViewMatrix.writeBuffer();const t=this.device.createCommandEncoder({label:"Skybox Command Encoder"}),s=t.beginRenderPass({label:"Skybox Render Pass",colorAttachments:[{loadOp:"clear",storeOp:"store",view:this.framebuffer.createView()}]});s.setPipeline(this.renderPipeline),s.setBindGroup(0,this.bindGroups[this.activeSkybox]),s.draw(3),s.end(),this.device.queue.submit([t.finish()])}setDimensions(e){this.dimensions=e,this.framebuffer?.destroy(),this.framebuffer=this.createFramebuffer()}}class L{static RENDER_SETTINGS_BYTE_LENGTH=1*Float32Array.BYTES_PER_ELEMENT;canvas;camera;settings;device;ctx;canvasFormat;initialised;skyboxRenderer;renderSettingsBuffer;renderBindGroupLayout;renderBindGroup;renderPipeline;renderTexture;renderSampler;computeSettingsBuffer;computeBindGroupLayout;computeBindGroup;computePipeline;constructor(e,t,s){const n=e.getContext("webgpu");if(n===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=s,this.ctx=n,this.canvasFormat="rgba8unorm",this.camera=new A,this.initialised=!1,this.settings={gamma:t.gamma??1.5}}serialiseSettings(){const e=new D(L.RENDER_SETTINGS_BYTE_LENGTH);return e.writeFloat32(this.settings.gamma),e.buffer}createRenderTexture(){return this.device.createTexture({label:"Render Texture",format:"rgba8unorm",size:[this.canvas.width,this.canvas.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}createRenderBindGroup(){return this.device.createBindGroup({label:"Renderer Bind Group",layout:this.renderBindGroupLayout,entries:[{binding:0,resource:{buffer:this.renderSettingsBuffer}},{binding:1,resource:this.renderTexture.createView()},{binding:2,resource:this.renderSampler}]})}createComputeBindGroup(){return this.device.createBindGroup({label:"Compute Bind Group",layout:this.computeBindGroupLayout,entries:[{binding:0,resource:{buffer:this.computeSettingsBuffer}},{binding:1,resource:{buffer:this.camera.buffer}},{binding:2,resource:this.renderTexture.createView()},{binding:3,resource:this.skyboxRenderer.framebuffer.createView()}]})}async initialise(){this.initialised||(this.camera.initialise(this.device),await this.initialiseRendering(),await this.initialiseCompute(),new ResizeObserver(e=>{const t=e[0],s=t.devicePixelContentBoxSize[0].inlineSize,n=t.devicePixelContentBoxSize[0].blockSize;this.canvas.width=s,this.canvas.height=n,this.renderTexture.destroy(),this.camera.setImageDimensions(s,n),this.skyboxRenderer.setDimensions([s,n]),this.renderTexture=this.createRenderTexture(),this.renderBindGroup=this.createRenderBindGroup(),this.computeBindGroup=this.createComputeBindGroup(),this.skyboxRenderer.render(this.camera),this.render()}).observe(this.canvas),this.initialised=!0)}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat}),this.skyboxRenderer=await I.create(this.device,this.canvasFormat,[this.canvas.width,this.canvas.height],"Skybox");const e=await N.createCubemap(this.device,"Skybox Texture","skybox");this.skyboxRenderer.addSkybox(e),this.skyboxRenderer.setActiveSkybox(e),this.renderSettingsBuffer=this.device.createBuffer({label:"Render Settings Buffer",size:L.RENDER_SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.device.queue.writeBuffer(this.renderSettingsBuffer,0,this.serialiseSettings()),this.renderTexture=this.createRenderTexture(),this.renderSampler=this.device.createSampler({label:"Renderer Texture Sampler"});const t=await U.fetch(this.device,C("shaders/render.wgsl"));this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{},visibility:GPUShaderStage.FRAGMENT}]}),this.renderBindGroup=this.createRenderBindGroup();const s=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:s,vertex:{module:t.shader,entryPoint:"vertexMain"},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]}})}async initialiseCompute(){this.computeSettingsBuffer=this.device.createBuffer({label:"Compute Settings Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.device.queue.writeBuffer(this.computeSettingsBuffer,0,new Float32Array([0]));const e=await U.fetch(this.device,C("shaders/simulation.wgsl"));this.computeBindGroupLayout=this.device.createBindGroupLayout({label:"Compute Bind Group Layout",entries:[{binding:0,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:2,storageTexture:{access:"write-only",format:"rgba8unorm"},visibility:GPUShaderStage.COMPUTE},{binding:3,storageTexture:{format:"rgba8unorm",access:"read-only"},visibility:GPUShaderStage.COMPUTE}]}),this.computeBindGroup=this.createComputeBindGroup();const t=this.device.createPipelineLayout({label:"Compute Pipeline Layout",bindGroupLayouts:[this.computeBindGroupLayout]});this.computePipeline=this.device.createComputePipeline({label:"Compute Pipeline",layout:t,compute:{module:e.shader,entryPoint:"main"}})}render(){this.compute(),this.renderToCanvas()}compute(){const e=this.device.createCommandEncoder(),t=e.beginComputePass();t.setBindGroup(0,this.computeBindGroup),t.setPipeline(this.computePipeline),t.dispatchWorkgroups(Math.ceil(this.canvas.width/8),Math.ceil(this.canvas.height/8),1),t.end(),this.device.queue.submit([e.finish()])}renderToCanvas(){const e=this.device.createCommandEncoder(),t=e.beginRenderPass({colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}]});t.setBindGroup(0,this.renderBindGroup),t.setPipeline(this.renderPipeline),t.draw(3),t.end(),this.device.queue.submit([e.finish()])}static async create(e,t={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter");const n=await s.requestDevice();if(n===null)throw new Error("Could not find suitable GPU Device");return new L(e,t,n)}}class Y{callbacks=[];frameID;lastFrameTime;firstFrameTime;constructor(){this.frameID=null,this.lastFrameTime=0,this.firstFrameTime=-1,this.callbacks=[]}start(){this.running||(this.firstFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.firstFrameTime<0&&(this.firstFrameTime=e,this.lastFrameTime=e);const t=e-this.lastFrameTime,s=e-this.firstFrameTime,n={deltaTime:t,totalTime:s};for(const i of this.callbacks)i(n);this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}async function H(){const G=document.getElementById("main"),e=await L.create(G,{gamma:1});await e.initialise();const t=new Y;t.addCallback(s=>{const n=s.totalTime/5e3;e.render(),e.camera.lookAt.x=Math.sin(n),e.camera.lookAt.z=Math.cos(n),e.camera.updateBuffer(),e.skyboxRenderer.render(e.camera)}),t.start()}H().catch(G=>{const e=G instanceof Error?G.message:JSON.stringify(G),t=document.getElementById("error");t!==null&&(t.textContent=e),console.error(e)});
